<!DOCTYPE html>
<html lang="tr">

<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kronometre Deneyi</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --green: #1f8f3a;
            --red: #b11226;
            --black: #000;
            --border: rgba(255, 255, 255, .6);
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: system-ui, sans-serif;
            background: var(--black);
            color: white;
            transition: background-color .4s linear;
        }

        .container {
            width: 100%;
            max-width: 460px;
            padding: 18px;
        }

        .panel {
            border: 2px solid var(--border);
            border-radius: 18px;
            padding: 22px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            text-align: center;
            background: transparent;
        }

        #time {
            font-size: clamp(34px, 8vw, 48px);
            font-weight: 600;
        }

        .progress-wrapper {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, .25);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 100%;
            background: white;
        }

        #clickCounter {
            font-size: 17px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        input[type=range] {
            width: 100%;
            accent-color: white;
        }

        .buttons {
            display: flex;
            gap: 12px;
        }

        button {
            flex: 1;
            padding: 14px 0;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }

        button:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

        #stats {
            display: none;
            margin-top: 14px;
            font-size: 13px;
            text-align: left;
        }

        canvas {
            margin-top: 20px;
            max-height: 260px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="panel">

            <div id="time">00:00:00</div>

            <div class="progress-wrapper">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div id="clickCounter">TÄ±klama: 0 / 40</div>

            <div>
                <div class="slider-label">
                    <span>Soru BaÅŸÄ±na (dk):</span>
                    <strong id="minuteLabel">2.5</strong>
                </div>
                <input type="range" id="timeSlider" min="0.25" max="5" step="0.25" value="2.5">
            </div>

            <div>
                <div class="slider-label">
                    <span>Soru SayÄ±sÄ±:</span>
                    <strong id="maxClickLabel">40</strong>
                </div>
                <input type="range" id="clickSlider" min="5" max="120" step="5" value="40">
            </div>

            <div class="buttons">
                <button id="start">BaÅŸlat</button>
                <button id="stop" disabled>Bitir</button>
            </div>

            <div id="stats"></div>
            <canvas id="deltaChart"></canvas>

        </div>
    </div>

    <script>
        /* ---------------- WAKE LOCK ---------------- */
        let wakeLock = null;

        async function enableWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request("screen");
                console.log("Wake Lock aktif");

                wakeLock.addEventListener("release", () => {
                    console.log("Wake Lock bÄ±rakÄ±ldÄ±");
                });
            } catch (err) {
                console.log("Wake Lock desteklenmiyor:", err);
            }
        }

        function disableWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        /* ---------------- FULLSCREEN ---------------- */
        function enterFullscreen() {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            else if (el.msRequestFullscreen) el.msRequestFullscreen();
        }

        /* ---------------- STATE ---------------- */
        let startTime = 0, elapsed = 0, interval = null;
        let cycleTime = 150000;

        let clicks = 0, MAX = 40;
        let experimentEnded = false;

        let redTimeout = null, progressInterval = null;

        let clickTimes = [];
        let deltas = [];
        let chart = null;

        /* ---------------- ELEMENTS ---------------- */
        const timeEl = document.getElementById("time");
        const progressBar = document.getElementById("progressBar");
        const counterEl = document.getElementById("clickCounter");
        const statsEl = document.getElementById("stats");

        const startBtn = document.getElementById("start");
        const stopBtn = document.getElementById("stop");

        const timeSlider = document.getElementById("timeSlider");
        const clickSlider = document.getElementById("clickSlider");
        const minuteLabel = document.getElementById("minuteLabel");
        const maxClickLabel = document.getElementById("maxClickLabel");

        /* ---------------- UTILS ---------------- */
        function fmt(ms) {
            const s = Math.floor(ms / 1000);
            return `${String(Math.floor(s / 3600)).padStart(2, "0")}:` +
                `${String(Math.floor(s / 60) % 60).padStart(2, "0")}:` +
                `${String(s % 60).padStart(2, "0")}`;
        }

        function updateCounter() {
            counterEl.textContent = `TÄ±klama: ${clicks} / ${MAX}`;
        }

        /* ---------------- CORE ---------------- */
        function start() {
            if (interval) return;

            timeSlider.disabled = true;
            clickSlider.disabled = true;
            startBtn.disabled = true;

            startTime = Date.now();
            interval = setInterval(() => {
                elapsed = Date.now() - startTime;
                timeEl.textContent = fmt(elapsed);
            }, 500);

            setGreenAndScheduleRed();
        }

        function finish() {
            if (clicks < MAX) return;

            clearInterval(interval);
            clearTimeout(redTimeout);
            clearInterval(progressInterval);

            disableWakeLock();   // ðŸ‘ˆ EKLENDÄ°

            document.body.style.background = "#000";
            experimentEnded = true;

            showStats();
        }

        function startProgress() {
            const start = Date.now();
            progressBar.style.width = "100%";

            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                const r = Math.max(0, 1 - (Date.now() - start) / cycleTime);
                progressBar.style.width = (r * 100) + "%";
            }, 50);
        }

        function setGreenAndScheduleRed() {
            document.body.style.background = "var(--green)";
            startProgress();

            clearTimeout(redTimeout);
            redTimeout = setTimeout(() => {
                document.body.style.background = "var(--red)";
                progressBar.style.width = "0%";
                clearInterval(progressInterval);
            }, cycleTime);
        }

        /* ---------------- STATS + CHART ---------------- */
        function showStats() {
            let html = "<h3>Ä°statistik Ã–zeti</h3>";

            deltas.forEach((d, i) => {
                html += `${i + 1}. tÄ±klama Î”t: ${(d / 1000).toFixed(2)} sn<br>`;
            });

            const avg = deltas.reduce((a, b) => a + b, 0) / deltas.length;
            html += `<hr><strong>Ortalama Î”t:</strong> ${(avg / 1000).toFixed(2)} sn`;

            statsEl.innerHTML = html;
            statsEl.style.display = "block";

            drawChart();
        }

        function drawChart() {
            const ctx = document.getElementById("deltaChart").getContext("2d");
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: deltas.map((_, i) => i + 1),
                    datasets: [{
                        label: "TÄ±klamalar ArasÄ± SÃ¼re (sn)",
                        data: deltas.map(d => (d / 1000).toFixed(2)),
                        borderWidth: 2,
                        tension: .3,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: "TÄ±klama NumarasÄ±" } },
                        y: { title: { display: true, text: "SÃ¼re (sn)" }, beginAtZero: true }
                    }
                }
            });
        }

        /* ---------------- EVENTS ---------------- */
        document.addEventListener("click", e => {
            if (!interval || experimentEnded) return;

            clicks++;
            updateCounter();

            clickTimes.push(elapsed);

            if (clickTimes.length === 1) {
                deltas.push(elapsed);
            } else {
                deltas.push(clickTimes.at(-1) - clickTimes.at(-2));
            }

            if (clicks >= MAX) {
                stopBtn.disabled = false;
                document.body.style.background = "#000";
                clearInterval(progressInterval);
                return;
            }

            setGreenAndScheduleRed();
        });


        timeSlider.oninput = () => {
            minuteLabel.textContent = timeSlider.value;
            cycleTime = timeSlider.value * 60 * 1000;
        };

        clickSlider.oninput = () => {
            MAX = Number(clickSlider.value);
            maxClickLabel.textContent = MAX;
            updateCounter();
        };

        /* FULLSCREEN DOÄžRU YERDE */
        startBtn.onclick = e => {
            e.stopPropagation();
            enterFullscreen();
            enableWakeLock();   // ðŸ‘ˆ EKLENDÄ°
            start();
        };


        stopBtn.onclick = e => {
            e.stopPropagation();
            finish();
        };

        updateCounter();
    </script>
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js");
        }
    </script>

</body>

</html>